<!DOCTYPE html>
<html lang="ja">
<head>
<title>上書き保存（Gemini版）</title>
<style>
body
{
    font-family: sans-serif;
    cursor: move;
}

button
{
    font-size: 20px;
    height: 40px;
    width: 200px;
    cursor: pointer;
}

button: disabled
{
    background-color: #ccc;
    cursor: not-allowed;
}

.container
{
    display: flex;
    margin-top: 20px;
    height: calc(100vh - 200px);
}

textarea, iframe
{
    width: 50%;
    border: 2px solid black;
    padding: 0px;
    box-sizing: border-box;
    resize: none;
    margin: 0px;
    zoom: 50%;
}

textarea
{
    font-size: 2em;
}

iframe
{
    background-color: white;
}
</style>
</head>
<body oninput="iframeUpdate()">

<div id="controls">
    <button id="openBtn" onclick="loadApi()">開く</button>
    <button id="saveBtn" onclick="saveFile()">保存</button>
    <button id="overwriteBtn" onclick="overwriteSavedFile()">上書き</button>
    <span id="statusMessage"></span>
</div>

<div class="container">
    <textarea id="editor"></textarea>
    <iframe id="preview" srcdoc></iframe>
</div>

<p></p>
<button id="colorMode" onclick="darkMode()" style="width: 50%;">ダークモードに切り替え</button>

<script>
'use strict';

let fileHandle = null;

const editor = document.getElementById('editor');
const preview = document.getElementById('preview');
const statusMessage = document.getElementById('statusMessage');
const openBtn = document.getElementById('openBtn');
const saveBtn = document.getElementById('saveBtn');
const overwriteBtn = document.getElementById('overwriteBtn');

function setStatus(message, isError = false)
{
    statusMessage.textContent = message;
    statusMessage.style.color = isError ? 'red' : 'green';
}

function setButtonsState(isLoading)
{
    openBtn.disabled = isLoading;
    saveBtn.disabled = isLoading;
    overwriteBtn.disabled = isLoading;
}

// ファイルを読み込む関数
async function loadApi()
{
    setButtonsState(true);
    setStatus('ファイルを読み込み中...');

    try
    {
        [fileHandle] = await window.showOpenFilePicker();
        const file = await fileHandle.getFile();
        const content = await file.text();
        editor.value = content;
        iframeUpdate();
        setStatus('ファイルを正常に読み込みました。', false);
    } catch (error) {
        setStatus('ファイルの読み込みに失敗しました。', true);
        console.error(error);
    } finally {
        setButtonsState(false);
    }
}

// 新規ファイルとして保存する関数
async function saveFile()
{
    setButtonsState(true);
    setStatus('ファイルを保存中...');
    
    try
    {
        fileHandle = await window.showSaveFilePicker();
        const writable = await fileHandle.createWritable();
        await writable.write(editor.value);
        await writable.close();
        setStatus('HTMLファイルが正常に保存されました。', false);
    } catch (error) {
        setStatus('ファイルの保存に失敗しました。', true);
        console.error(error);
    } finally {
        setButtonsState(false);
    }
}

// 既存のファイルを上書きする関数
async function overwriteSavedFile()
{
    if (!fileHandle)
    {
        saveFile();
        return;
    }

    setButtonsState(true);
    setStatus('ファイルを上書きしています...');

    try
    {
        const writable = await fileHandle.createWritable();
        await writable.write(editor.value);
        await writable.close();
        setStatus('ファイルが正常に上書きされました。');
    } catch (error) {
        setStatus('ファイルの上書き中にエラーが発生しました。', true);
        console.error(error);
    } finally {
        setButtonsState(false);
    }
}

// iframeの内容を更新する関数
function iframeUpdate()
{
    preview.srcdoc = editor.value;
    setStatus('保存されていない変更があります', true);
}

function darkMode()
{
    const body = document.querySelector('body');
    const colorMode = document.getElementById('colorMode');
    body.style.backgroundColor = 'rgb(0, 0, 0)';
    body.style.color = 'rgb(255, 255, 255)';
    editor.style.backgroundColor = 'rgb(0, 0, 0)';
    editor.style.color = 'rgb(255, 255, 255)';
    colorMode.onclick = lightMode;
    colorMode.innerText = "ライトモードに切り替え";
}

function lightMode()
{
    const body = document.querySelector('body');
    const colorMode = document.getElementById('colorMode');
    body.style.backgroundColor = 'rgb(255, 255, 255)';
    body.style.color = 'rgb(0, 0, 0)';
    editor.style.backgroundColor = 'rgb(255, 255, 255)';
    editor.style.color = 'rgb(0, 0, 0)';
    colorMode.onclick = darkMode;
    colorMode.innerText = "ダークモードに切り替え";
}
</script>
</body>
</html>
